<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="movies">
 	<select id="selectAll" resultType="mybatis.vo.Movie">
 		SELECT * FROM TBL_MOVIE
 	</select>
 	<select id="search" resultType="mybatis.vo.Movie" parameterType="java.util.Map">
 		SELECT * FROM TBL_MOVIE
 		<where>
	 		<if test="mname!=null">
	 			mname like '%' || #{mname}|| '%'		
	 		</if>
	 		<if test="genre!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					genre like '%' || #{genre} || '%'				
	 			</trim>
	 		</if>
	 		<if test="director!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					director like '%' || #{director} || '%'				
	 			</trim>
	 		</if>
	 		<if test="release_date!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					release_date like '%' || #{release_date} || '%'			
	 			</trim>
	 		</if>
	 		<if test="producer!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					producer like '%' || #{producer} || '%'					
	 			</trim>
	 		</if>
	 		<if test="rating!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					rating = #{rating}					
	 			</trim>
	 		</if>
	 		<if test="running_time!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					running_time = #{running_time}						
	 			</trim>
	 		</if>
	 		<if test="mgrade!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					mgrade = #{mgrade}			
	 			</trim>
	 		</if>
	 		<if test="country!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					country like '%' || #{country} || '%'					
	 			</trim>
	 		</if>
	 		<if test="mcast!=null">
	 			<trim prefix="and">  <!-- 앞의 검색 조건 여부에 따라 and 추가  -->
					mcast like '%' || #{mcast} || '%'					
	 			</trim>
	 		</if>
 		</where>
 	</select>
 	<select id="getOne" parameterType="int" resultType="mybatis.vo.Movie">
 		SELECT * 
		FROM tbl_movie
		WHERE mcode = #{mcode} 
 	</select>
 	<select id="selectByIdx" parameterType="long" resultType="mybatis.vo.Movie">
 		SELECT * 
 		FROM tbl_movie
 		WHERE mcode = #{mcode}   <!-- PK로 조회 -->
 	</select>
 	<delete id="delete" parameterType="int">
 		DELETE FROM tbl_movie WHERE mcode=#{mcode}
 	</delete>
 	<select id="count" resultType="int">
 		SELECT count(*) FROM tbl_movie
 	</select>
 	<select id="pagelist" resultType="mybatis.vo.Movie" parameterType="java.util.Map">
 		SELECT * FROM 
			(SELECT rownum r ,f.* FROM
								(SELECT * FROM tbl_movie ORDER BY mcode DESC) f)
		WHERE r BETWEEN #{start} AND #{end}
 	</select>
 	<insert id="insert" parameterType="mybatis.vo.Movie">
 		INSERT INTO TBL_MOVIE
		VALUES (
			movie_idx_seq.nextval, #{mname}, #{genre}, #{director},
			#{release_date}, #{producer}, #{running_time}, #{rating},
			#{synopsys}, #{mgrade}, #{country}, #{mcast}, #{poster}
		)
 	</insert>
 	 
 		
 		<!-- 상영 중 조회  -->
 		 <select id="selectCurrentMovies" resultType="mybatis.vo.Movie">
		    SELECT m.*, s.schedule
		    FROM TBL_MOVIE m
		    INNER JOIN TBL_SCHEDULE s ON m.mcode = s.mcode
		    WHERE s.schedule BETWEEN SYSDATE AND ADD_MONTHS(SYSDATE, 1)
		 </select>
		 
		 <!-- 상영 종료  -->
		 <select id = "selectEndMovies" resultType = "mybatis.vo.Movie">
		  <![CDATA[
			SELECT m.*, s.schedule 
			FROM TBL_MOVIE m 
			INNER JOIN TBL_SCHEDULE s ON m.mcode = s.mcode 
			WHERE s.schedule < ADD_MONTHS(SYSDATE, -1)
			]]>
		 </select>
		 
		 <!-- 상영 예정 -->
		 	<select id = "selectUpcomingMovies" resultType = "mybatis.vo.Movie">
		 	SELECT m.*, s.schedule 
			FROM TBL_MOVIE m 
			INNER JOIN TBL_SCHEDULE s ON m.mcode = s.mcode 
			WHERE s.schedule > ADD_MONTHS(SYSDATE, 1)
		 	</select>
 		
		 <select id = "todayLater" resultType="mybatis.vo.Schedule">
				 SELECT ADD_MONTHS(schedule, 1), 'YYYY-MM-DD' FROM TBL_SCHEDULE
		 </select>
		 
 		<select id = "selectMovieById" parameterType = "long" resultType="mybatis.vo.Movie">
 				SELECT *
 				FROM TBL_MOVIE
 				WHERE mcode=#{mcode}
 		</select>
 </mapper>
